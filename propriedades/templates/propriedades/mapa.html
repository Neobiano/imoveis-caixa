{% load static %}
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Imóveis Caixa - Mapa</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <style>
        #map {
            height: calc(100vh - 60px);
            width: 100%;
        }
        .filters-panel {
            background: white;
            padding: 15px;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        .property-popup {
            max-width: 300px;
        }
        .property-popup img {
            width: 100%;
            height: 150px;
            object-fit: cover;
        }
        .custom-div-icon {
            background: #fff;
            border-radius: 50%;
            width: 30px !important;
            height: 30px !important;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid #666;
        }
        .custom-div-icon i {
            color: #666;
            font-size: 14px;
        }
        .custom-div-icon.casa {
            border-color: #28a745;
        }
        .custom-div-icon.casa i {
            color: #28a745;
        }
        .custom-div-icon.apartamento {
            border-color: #007bff;
        }
        .custom-div-icon.apartamento i {
            color: #007bff;
        }
        .custom-div-icon.terreno {
            border-color: #fd7e14;
        }
        .custom-div-icon.terreno i {
            color: #fd7e14;
        }
        .custom-div-icon.comercial {
            border-color: #6f42c1;
        }
        .custom-div-icon.comercial i {
            color: #6f42c1;
        }
        .custom-div-icon.rural {
            border-color: #20c997;
        }
        .custom-div-icon.rural i {
            color: #20c997;
        }
        /* Estilo para o slider de desconto */
        .desconto-slider {
            width: 100%;
            margin: 10px 0;
        }
        .desconto-valor {
            text-align: center;
            font-weight: bold;
            margin: 5px 0;
            color: #007bff;
        }
        .slider-container {
            text-align: center;
            padding: 10px 0;
        }
        input[type="range"] {
            -webkit-appearance: none;
            width: 100%;
            height: 8px;
            border-radius: 5px;
            background: #e9ecef;
            outline: none;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #007bff;
            cursor: pointer;
            transition: background .15s ease-in-out;
        }
        input[type="range"]::-webkit-slider-thumb:hover {
            background: #0056b3;
        }
        .btn-obter-valor {
            background: #007bff;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.2s;
            margin-top: 10px;
            width: 100%;
        }
        .btn-obter-valor:hover {
            background: #0056b3;
        }
        /* Estilo para os checkboxes */
        .checkbox-group {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 10px;
            margin-bottom: 10px;
        }
        .checkbox-search {
            width: 100%;
            padding: 5px;
            margin-bottom: 10px;
            border: 1px solid #dee2e6;
            border-radius: 4px;
        }
        .checkbox-item {
            display: block;
            margin-bottom: 5px;
        }
        .checkbox-item input[type="checkbox"] {
            margin-right: 5px;
        }
        .checkbox-item label {
            cursor: pointer;
            user-select: none;
        }
        .checkbox-group::-webkit-scrollbar {
            width: 8px;
        }
        .checkbox-group::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }
        .checkbox-group::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }
        .checkbox-group::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">Imóveis Caixa</a>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <!-- Filtros -->
            <div class="col-md-3 p-3">
                <div class="filters-panel">
                    <h5>Filtros</h5>
                    <form id="filterForm">
                        <div class="mb-3">
                            <label class="form-label">Estado</label>
                            <input type="text" class="checkbox-search" placeholder="Buscar estados..." id="estado-search">
                            <div class="checkbox-group" id="estados-group">
                                {% for estado in estados %}
                                    <div class="checkbox-item">
                                        <input type="checkbox" name="estado" value="{{ estado }}" id="estado-{{ estado }}">
                                        <label for="estado-{{ estado }}">{{ estado }}</label>
                                    </div>
                                {% endfor %}
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Cidade</label>
                            <input type="text" class="checkbox-search" placeholder="Buscar cidades..." id="cidade-search">
                            <div class="checkbox-group" id="cidades-group">
                                <!-- Será preenchido via JavaScript -->
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Bairro</label>
                            <input type="text" class="checkbox-search" placeholder="Buscar bairros..." id="bairro-search">
                            <div class="checkbox-group" id="bairros-group">
                                <!-- Será preenchido via JavaScript -->
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Tipo de Imóvel</label>
                            <input type="text" class="checkbox-search" placeholder="Buscar tipos..." id="tipo-search">
                            <div class="checkbox-group" id="tipos-group">
                                {% for tipo in tipos_imovel %}
                                    <div class="checkbox-item">
                                        <input type="checkbox" name="tipo_imovel" value="{{ tipo }}" id="tipo-{{ tipo }}">
                                        <label for="tipo-{{ tipo }}">{{ tipo }}</label>
                                    </div>
                                {% endfor %}
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Valor Máximo</label>
                            <input type="number" class="form-control" id="valor_max" name="valor_max">
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Desconto Mínimo (%)</label>
                            <div class="slider-container">
                                <input type="range" class="desconto-slider" id="desconto_min" name="desconto_min" 
                                       min="0" max="100" value="0" step="1">
                                <div class="desconto-valor"><span id="desconto_valor">0</span>%</div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Quartos</label>
                            <div class="checkbox-group">
                                <div class="checkbox-item">
                                    <input type="checkbox" name="quartos" value="1" id="quartos-1">
                                    <label for="quartos-1">1+ quartos</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" name="quartos" value="2" id="quartos-2">
                                    <label for="quartos-2">2+ quartos</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" name="quartos" value="3" id="quartos-3">
                                    <label for="quartos-3">3+ quartos</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" name="quartos" value="4" id="quartos-4">
                                    <label for="quartos-4">4+ quartos</label>
                                </div>
                            </div>
                        </div>
                        
                        <button type="submit" class="btn btn-primary w-100">Aplicar Filtros</button>
                    </form>
                </div>
            </div>
            
            <!-- Mapa -->
            <div class="col-md-9 p-0">
                <div id="map"></div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // Função para formatar valores monetários no padrão brasileiro
        function formatarMoeda(valor) {
            return new Intl.NumberFormat('pt-BR', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(valor);
        }

        // Atualizar o valor do desconto quando o slider é movido
        document.getElementById('desconto_min').addEventListener('input', function() {
            document.getElementById('desconto_valor').textContent = this.value;
        });

        // Inicializar o mapa
        var map = L.map('map').setView([-15.7801, -47.9292], 4);  // Centro do Brasil
        
        // Adicionar camada do OpenStreetMap
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '© OpenStreetMap contributors'
        }).addTo(map);

        // Ícones personalizados por tipo de imóvel
        function createCustomIcon(tipo) {
            let iconClass = 'fa-home';  // ícone padrão
            let divClass = '';
            
            tipo = tipo.toLowerCase();
            if (tipo.includes('casa')) {
                iconClass = 'fa-house';
                divClass = 'casa';
            } else if (tipo.includes('apartamento')) {
                iconClass = 'fa-building';
                divClass = 'apartamento';
            } else if (tipo.includes('terreno')) {
                iconClass = 'fa-mountain';
                divClass = 'terreno';
            } else if (tipo.includes('comercial') || tipo.includes('sala') || tipo.includes('loja') || tipo.includes('galpão')) {
                iconClass = 'fa-store';
                divClass = 'comercial';
            } else if (tipo.includes('rural') || tipo.includes('fazenda') || tipo.includes('sítio') || tipo.includes('chácara')) {
                iconClass = 'fa-wheat-awn';
                divClass = 'rural';
            }

            return L.divIcon({
                className: `custom-div-icon ${divClass}`,
                html: `<i class="fa-solid ${iconClass}"></i>`,
                iconSize: [30, 30],
                iconAnchor: [15, 15]
            });
        }

        // Função para filtrar checkboxes baseado na busca
        function filterCheckboxes(searchInput, groupId) {
            const searchTerm = searchInput.value.toLowerCase();
            const checkboxes = document.querySelectorAll(`#${groupId} .checkbox-item`);
            
            checkboxes.forEach(item => {
                const label = item.querySelector('label').textContent.toLowerCase();
                if (label.includes(searchTerm)) {
                    item.style.display = '';
                } else {
                    item.style.display = 'none';
                }
            });
        }

        // Adicionar eventos de busca para cada grupo
        document.getElementById('estado-search').addEventListener('input', function() {
            filterCheckboxes(this, 'estados-group');
        });

        document.getElementById('cidade-search').addEventListener('input', function() {
            filterCheckboxes(this, 'cidades-group');
        });

        document.getElementById('bairro-search').addEventListener('input', function() {
            filterCheckboxes(this, 'bairros-group');
        });

        document.getElementById('tipo-search').addEventListener('input', function() {
            filterCheckboxes(this, 'tipos-group');
        });

        // Função para carregar cidades quando estados forem selecionados
        function loadCidades() {
            const estadosSelecionados = Array.from(document.querySelectorAll('input[name="estado"]:checked')).map(cb => cb.value);
            const cidadesGroup = document.getElementById('cidades-group');
            cidadesGroup.innerHTML = '<div class="text-center"><small>Carregando...</small></div>';
            
            Promise.all(estadosSelecionados.map(estado =>
                fetch(`/api/cidades/${estado}`).then(response => response.json())
            )).then(results => {
                const todasCidades = [...new Set(results.flat())];
                cidadesGroup.innerHTML = todasCidades.map(cidade => `
                    <div class="checkbox-item">
                        <input type="checkbox" name="cidade" value="${cidade}" id="cidade-${cidade}">
                        <label for="cidade-${cidade}">${cidade}</label>
                    </div>
                `).join('');
                
                // Reaplica o filtro de busca
                filterCheckboxes(document.getElementById('cidade-search'), 'cidades-group');
            });
        }

        // Função para carregar bairros quando cidades forem selecionadas
        function loadBairros() {
            const cidadesSelecionadas = Array.from(document.querySelectorAll('input[name="cidade"]:checked')).map(cb => cb.value);
            const bairrosGroup = document.getElementById('bairros-group');
            bairrosGroup.innerHTML = '<div class="text-center"><small>Carregando...</small></div>';
            
            Promise.all(cidadesSelecionadas.map(cidade =>
                fetch(`/api/bairros/${cidade}`).then(response => response.json())
            )).then(results => {
                const todosBairros = [...new Set(results.flat())].filter(Boolean);
                bairrosGroup.innerHTML = todosBairros.map(bairro => `
                    <div class="checkbox-item">
                        <input type="checkbox" name="bairro" value="${bairro}" id="bairro-${bairro}">
                        <label for="bairro-${bairro}">${bairro}</label>
                    </div>
                `).join('');
                
                // Reaplica o filtro de busca
                filterCheckboxes(document.getElementById('bairro-search'), 'bairros-group');
            });
        }

        // Eventos para carregar cidades e bairros
        document.querySelectorAll('input[name="estado"]').forEach(checkbox => {
            checkbox.addEventListener('change', loadCidades);
        });

        document.getElementById('cidades-group').addEventListener('change', function(e) {
            if (e.target.type === 'checkbox') {
                loadBairros();
            }
        });

        // Função para carregar os imóveis com múltipla seleção
        function loadProperties(filters = {}) {
            // Converter arrays de valores em strings separadas por vírgula
            const queryParams = new URLSearchParams();
            for (const [key, value] of Object.entries(filters)) {
                if (Array.isArray(value)) {
                    queryParams.append(key, value.join(','));
                } else {
                    queryParams.append(key, value);
                }
            }

            fetch(`/api/propriedades/?${queryParams}`)
                .then(response => response.json())
                .then(data => {
                    // Limpar marcadores existentes
                    map.eachLayer((layer) => {
                        if (layer instanceof L.Marker) {
                            map.removeLayer(layer);
                        }
                    });

                    // Adicionar novos marcadores
                    data.forEach(property => {
                        if (property.latitude && property.longitude) {
                            const tipo = property.tipo_imovel || '';
                            const marker = L.marker([property.latitude, property.longitude], {
                                icon: createCustomIcon(tipo)
                            })
                                .bindPopup(`
                                    <div class="property-popup">
                                        ${property.imagem_url ? 
                                            `<img src="${property.imagem_url}" alt="Foto do imóvel" class="mb-2">` : 
                                            ''
                                        }
                                        <h6>${property.tipo_imovel}</h6>
                                        <p>${property.endereco}<br>
                                        ${property.bairro ? property.bairro + '<br>' : ''}
                                        ${property.cidade} - ${property.estado}</p>
                                        <p><strong>Valor de Venda: R$ ${formatarMoeda(property.valor)}</strong></p>
                                        ${property.valor_avaliacao ? 
                                            `<p><strong>Valor de Avaliação: R$ ${formatarMoeda(property.valor_avaliacao)}</strong></p>` : 
                                            ''}
                                        ${property.desconto ? 
                                            `<p><strong>Desconto: ${property.desconto}%</strong></p>` : 
                                            ''}
                                        <p>${property.quartos} quartos | ${property.area}m²</p>
                                        <a href="${property.link}" target="_blank" class="btn btn-primary btn-sm">Ver Detalhes</a>
                                    </div>
                                `);
                            marker.addTo(map);
                        }
                    });
                });
        }

        // Aplicar filtros com múltipla seleção
        document.getElementById('filterForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const filters = {
                estado: Array.from(document.querySelectorAll('input[name="estado"]:checked')).map(cb => cb.value),
                cidade: Array.from(document.querySelectorAll('input[name="cidade"]:checked')).map(cb => cb.value),
                bairro: Array.from(document.querySelectorAll('input[name="bairro"]:checked')).map(cb => cb.value),
                tipo_imovel: Array.from(document.querySelectorAll('input[name="tipo_imovel"]:checked')).map(cb => cb.value),
                quartos: Array.from(document.querySelectorAll('input[name="quartos"]:checked')).map(cb => cb.value),
                valor_max: document.getElementById('valor_max').value,
                desconto_min: document.getElementById('desconto_min').value
            };
            
            loadProperties(filters);
        });

        // Carregar imóveis iniciais
        loadProperties();
    </script>
</body>
</html> 